---
import type { ECategory } from '../types/category';
import type { ISocial, IImageMetadata } from "../types/social";

import { Image } from "astro:assets";

import FormattedDate from "./FormattedDate.astro";
import { normalizeStrToAmpersand } from '../utils/utils';

import BookmarkSVG from "../../public/svg/bookmark.svg";
import HeartSVG from "../../public/svg/heart.svg";
import CommentSVG from "../../public/svg/comment.svg";

interface Props {
    author: {name: string; avatar: string;}
    pubDate: Date;
    socials: ISocial[];
    categories: ECategory[];
    commentsCount: number;
    slug: string;
}

const { author, socials, pubDate, categories, commentsCount, slug } = Astro.props;

const socialSvgs: IImageMetadata = {
    facebook: "/svg/facebook-circle.svg",
    pinterest: "/svg/pinterest-circle.svg",
    twitter: "/svg/twitter-circle.svg",
};
---

<div class="meta">
    <div class="meta-top">
        {
            categories && (
            <div class="categories">
                    <Image
                        src={BookmarkSVG}
                        alt="Bookmark icon"
                        width="15"
                        height="15"
                    />
                    <ul class="categories-list">
                        {categories.map((category) => (
                            <li class="category">
                                <a class="category-link" href={`/category/${category}`}>
                                    {normalizeStrToAmpersand(category)}
                                </a>
                            </li>
                        ))}
                    </ul>
                </div>
            )
        }
        <button
            class="likes"
            id="like-button"
            data-slug={slug}
            aria-label="Like this post"
        >
            <HeartSVG
                id="heart-icon"
                width="15"
                height="15"
            />
            <span class="count" id="likes-count">0</span>
        </button>
        <div class="comments">
            <Image
                src={CommentSVG}
                alt="Comment icon"
                width="13"
                height="13"
            />
            <span class="count">{commentsCount ?? 0}</span>
        </div>
    </div>
    <div class="meta-bottom">
        <a class="author" href="/">{author.name}</a>
        <ul class="socials">
            {
                socials && socials.map(({ social, url }) => (
                    <li class="social">
                        <a href={url}>
                            <Image
                                src={socialSvgs[social]}
                                alt=`${social} social`
                                width="24"
                                height="24"
                            />
                        </a>
                    </li>
                ))
            }
        </ul>
        <FormattedDate class="date" date={pubDate} />
    </div>
</div>

<style>
    .meta-bottom {
        display: flex;
        justify-content: space-between;
        margin-top: 43px;
        padding: 19px 0 14px;
        border-top: 1px solid var(--color-border-2);
        border-bottom: 1px solid var(--color-border-2);
    }
    .categories {
        display: flex;
        gap: 5px;
    }
    .categories-list {
        display: flex;
        gap: 3px;
    }
    .category {
        .category-link {
            text-transform: capitalize;
            font-size: 15px;
            font-family: var(--family-lora);
            font-style: italic;
            color: var(--color-grey-2);
        }

        &:hover .category-link {
            color: var(--color-dark);
        }
    }
    .meta-top,
    .categories,
    .likes,
    .comments {
        display: flex;
        align-items: center;
    }
    .meta-top {
        gap: 20px;
    }
    .comments,
    .likes {
        gap: 3px;

        .count {
            font-size: 15px;
            color: var(--color-grey-2);
            font-family: var(--family-lora);
            font-style: italic;
            transition: var(--trasition-default);
        }
    }
    .likes {
        background: none;
        border: none;
        padding: 0;
        cursor: pointer;

        &:hover {
            .count {
                color: var(--color-black);
            }
        }

        #heart-icon g path {
            fill: var(--color-black);
        }

        &.liked #heart-icon {
            filter: brightness(0) saturate(100%) invert(27%) sepia(98%) saturate(3489%) hue-rotate(338deg) brightness(91%) contrast(96%);
        }

        &.loading {
            opacity: 0.6;
            cursor: not-allowed;
        }
    }
    .author {
        text-transform: uppercase;
        font-size: 10px;
        letter-spacing: var(--letter-spacing-default);
        color: var(--color-grey-2);

        &:hover {
            color: var(--color-black);
        }
    }
    .socials {
        display: flex;
        gap: 18px;
    }
    .date {
        font-size: 15px;
        font-family: var(--family-lora);
        font-style: italic;
        color: var(--color-grey-2);
    }
</style>

<script>
  // Client-side like functionality
  const likeButton = document.getElementById('like-button') as HTMLButtonElement;
  const likesCountElement = document.getElementById('likes-count') as HTMLSpanElement;

  if (likeButton) {
    const slug = likeButton.dataset.slug;
    const STORAGE_KEY = `liked-${slug}`;

    async function initializeLikes() {
      try {
        const apiUrl = `/api/likes/get?slug=${encodeURIComponent(slug!)}`;

        const response = await fetch(apiUrl);
        const data = await response.json();

        if (response.ok) {
          likesCountElement.textContent = data.count.toString();

          // Use server state as source of truth
          if (data.hasLiked) {
            likeButton.classList.add('liked');
            localStorage.setItem(STORAGE_KEY, 'true');
          } else {
            likeButton.classList.remove('liked');
            localStorage.removeItem(STORAGE_KEY);
          }
        } else {
          console.error('Failed to fetch likes:', data);
        }
      } catch (error) {
        console.error('Failed to initialize likes:', error);
      }
    }

    // Toggle like
    async function toggleLike() {
      if (likeButton.classList.contains('loading')) {
        return; // Prevent double-clicks
      }

      likeButton.classList.add('loading');

      try {
        const response = await fetch('/api/likes/toggle', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ slug }),
        });

        const data = await response.json();

        if (response.ok) {
          // Update UI
          likesCountElement.textContent = data.count.toString();

          if (data.hasLiked) {
            likeButton.classList.add('liked');
            localStorage.setItem(STORAGE_KEY, 'true');
          } else {
            likeButton.classList.remove('liked');
            localStorage.removeItem(STORAGE_KEY);
          }
        } else {
          console.error('Failed to toggle like:', data.error);
        }
      } catch (error) {
        console.error('Failed to toggle like:', error);
      } finally {
        likeButton.classList.remove('loading');
      }
    }

    likeButton.addEventListener('click', toggleLike);

    initializeLikes();
  } else {
    console.error('Like button element not found!');
  }
</script>
