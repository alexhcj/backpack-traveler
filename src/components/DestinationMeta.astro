---
import type { ISocial, IImageMetadata } from "../types/social";
import type { ECategory } from "../types/category";

import { Image } from "astro:assets";

import { normalizeStrToAmpersand } from "../utils/utils";

import BookmarkSVG from "../../public/svg/bookmark.svg";
import HeartSVG from "../../public/svg/heart.svg";
import CommentSVG from "../../public/svg/comment.svg";

interface Props {
    socials: ISocial[];
    categories: ECategory[];
    commentsCount: number;
    slug: string;
}

const { socials, categories, commentsCount, slug } = Astro.props;

const socialSvgs: IImageMetadata = {
    facebook: "/svg/facebook-circle.svg",
    pinterest: "/svg/pinterest-circle.svg",
    twitter: "/svg/twitter-circle.svg",
};
---

<div class="destination-meta">
    <div class="meta">
        {
            categories && (
            <div class="categories">
                    <Image
                        src={BookmarkSVG}
                        alt="Bookmark icon"
                        width="15"
                        height="15"
                    />
                    <ul class="categories-list">
                        {categories.map((category) => (
                            <li class="category">
                                <a class="category-link" href={`/category/${category}`}>
                                    {normalizeStrToAmpersand(category)}
                                </a>
                            </li>
                        ))}
                    </ul>
                </div>
            )
        }
        <button
            class="likes"
            id="like-button"
            data-slug={slug}
            data-type="destination"
            aria-label="Like this destination"
        >
            <Image
                src={HeartSVG}
                alt="Heart icon"
                width="15"
                height="15"
                id="heart-icon"
            />
            <span class="count" id="likes-count">0</span>
        </button>
        <div class="comments">
            <Image
                src={CommentSVG}
                alt="Comment icon"
                width="13"
                height="13"
            />
            <span class="count">{commentsCount ?? 0}</span>
        </div>
    </div>
    <ul class="socials">
        {
            socials && socials.map(({ social, url }) => (
                <li class="social">
                    <a href={url}>
                        <Image
                            src={socialSvgs[social]}
                            alt=`${social} social`
                            width="24"
                            height="24"
                        />
                    </a>
                </li>
            ))
        }
    </ul>
</div>

<style>
    .destination-meta {
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .meta,
    .categories,
    .likes,
    .comments {
        display: flex;
        align-items: center;
    }

    .meta {
        gap: 20px;
    }

    .categories {
        display: flex;
        gap: 5px;
    }

    .categories-list {
        display: flex;
        gap: 3px;
    }

    .category {
        .category-link {
            text-transform: capitalize;
            font-size: 15px;
            font-family: var(--family-lora);
            font-style: italic;
            color: var(--color-grey-2);
        }

        &:hover .category-link {
            color: var(--color-dark);
        }
    }

    .comments,
    .likes {
        gap: 3px;

        .count {
            font-size: 15px;
            color: var(--color-grey-2);
            font-family: var(--family-lora);
            font-style: italic;
            transition: var(--transition-default);
        }
    }

    .comments,
    .likes {
        background: none;
        border: none;
        padding: 0;
        cursor: pointer;

        &:hover {
            .count {
                color: var(--color-black);
            }
        }
    }

    .likes {
        #heart-icon g path {
            fill: var(--color-black);
        }

        &.liked #heart-icon {
            filter: brightness(0) saturate(100%) invert(27%) sepia(98%) saturate(3489%) hue-rotate(338deg) brightness(91%) contrast(96%);
        }

        &.loading {
            opacity: 0.6;
            cursor: not-allowed;
        }
    }

    .socials {
        display: flex;
        justify-content: center;
        gap: 18px;
    }
</style>

<script>
  const likeButton = document.getElementById('like-button') as HTMLButtonElement;
  const likesCountElement = document.getElementById('likes-count') as HTMLSpanElement;

  if (likeButton) {
    const slug = likeButton.dataset.slug;
    const type = likeButton.dataset.type || 'destination';

    if (!slug) {
      console.error('ERROR: Slug is missing!');
    }

    const STORAGE_KEY = `liked-${type}-${slug}`;

    // Initialize engagement
    async function initializeEngagement() {
      try {
        const apiUrl = `/api/engagement/get?slug=${encodeURIComponent(slug!)}&type=${type}`;
        const response = await fetch(apiUrl);
        const data = await response.json();

        if (response.ok) {
          likesCountElement.textContent = data.count.toString();

          if (data.hasLiked) {
            likeButton.classList.add('liked');
            localStorage.setItem(STORAGE_KEY, 'true');
          } else {
            likeButton.classList.remove('liked');
            localStorage.removeItem(STORAGE_KEY);
          }
        } else {
          console.error('Failed to fetch engagement:', data);
        }
      } catch (error) {
        console.error('Failed to initialize engagement:', error);
      }
    }

    // Toggle engagement
    async function toggleEngagement() {
      if (likeButton.classList.contains('loading')) {
        return;
      }

      likeButton.classList.add('loading');

      try {
        const response = await fetch('/api/engagement/toggle', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ slug, type }),
        });

        const data = await response.json();

        if (response.ok) {
          likesCountElement.textContent = data.count.toString();

          if (data.hasLiked) {
            likeButton.classList.add('liked');
            localStorage.setItem(STORAGE_KEY, 'true');
          } else {
            likeButton.classList.remove('liked');
            localStorage.removeItem(STORAGE_KEY);
          }
        } else {
          console.error('Failed to toggle engagement:', data.error);
        }
      } catch (error) {
        console.error('Failed to toggle engagement:', error);
      } finally {
        likeButton.classList.remove('loading');
      }
    }

    likeButton.addEventListener('click', toggleEngagement);
    initializeEngagement();
  }
</script>
